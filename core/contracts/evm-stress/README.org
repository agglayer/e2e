#+TITLE: Using the EVM Stress Contract
#+DATE:
#+AUTHOR: John Hilliard
#+EMAIL: jhilliard@polygon.technology
#+CREATOR: John Hilliard
#+DESCRIPTION:


#+OPTIONS: toc:nil
#+LATEX_HEADER: \usepackage{geometry}
#+LATEX_HEADER: \usepackage{lmodern}
#+LATEX_HEADER: \geometry{left=1in,right=1in,top=1in,bottom=1in}
#+LaTeX_CLASS_OPTIONS: [letterpaper]

The EVM Stress contract is meant to be a simple contract that allows
us to trigger various load which can help us stress test EVM
implementations and provers.

There are generally three inputs to the smart contract
- ~action~ is like a selector which defines which opcode or method
  we'll be calling
- ~limit~ determines the lower bound on gas for any loops that we
  run. If the ~gas()~ drops below the ~limit~, we'll stop looping.
- ~extaddress~ can be used when opcodes require some address

| OPCode       | Action | Description                                   |
|--------------+--------+-----------------------------------------------|
| ADD          | 0x0000 | r := 1 + limit                                |
| ADD          | 0x0001 | repeat r := r + 1                             |
| KECCACK256   | 0x0002 | r := keccack256(extaddress)                   |
| KECCACK256   | 0x0003 | repeat r := keccack(r)                        |
| CALLDATACOPY | 0x0004 | calldatacopy(0,0,limit)                       |
| CALLDATACOPY | 0x0005 | repeat calldatacopy(0,0,32)                   |
| CODECOPY     | 0x0006 | codecopy(0,0,limit)                           |
| CODECOPY     | 0x0007 | repeat codecopy(0,0,32)                       |
| EXTCODECOPY  | 0x0008 | extcodecopy(extaddress,0,0,limit)             |
| EXTCODECOPY  | 0x0009 | repeat extcodecopy(extaddress,0,0,limit)      |
| EXTCODESIZE  | 0x000A | r := extcodesize(extaddress)                  |
| EXTCODESIZE  | 0x000B | repeat r := extcodesize(extaddress)           |
| EXTCODEHASH  | 0x000C | r := extcodehash(extaddress)                  |
| EXTCODEHASH  | 0x000D | repeat r := extcodehash(extaddress)           |
| BLOCKHASH    | 0x000E | r := blockhash(limit)                         |
| BLOCKHASH    | 0x000F | repeat r := blockhash(n)   # Descending       |
| MLOAD        | 0x0010 | r := mload(limit)                             |
| MLOAD        | 0x0011 | repeat r := mload(n)        # Ascending       |
| MSTORE       | 0x0012 | mstore(limit, extaddress)                     |
| MSTORE       | 0x0013 | repeat mstore(n, extaddress)  # Ascending     |
| SLOAD        | 0x0014 | r := sload(limit)                             |
| SLOAD        | 0x0015 | repeat r := sload(n)        # Ascending       |
| SSTORE       | 0x0016 | sstore(limit, extaddress)                     |
| SSTORE       | 0x0017 | repeat sstore(n, n)         # Ascending       |
| MCOPY        | 0x0018 | mcopy(0,32,limit)                             |
| MCOPY        | 0x0019 | repeat mcopy(0,n,32)        # Ascending (+32) |
| LOG4         | 0x001A | log4(0,limit,0,0,0,0)                         |
| LOG4         | 0x001B | repeat log4(0,32,0,0,0,0)                     |
| CREATE       | 0x001C | r := create(0,0,limit)                        |
| CREATE       | 0x001D | repeat r := create(0,0,24)                    |
| CREATE2      | 0x001E | r := create2(0,0,limit,0)                     |
| CREATE2      | 0x001F | repeat r := create2(0,0,24,r)                 |
| ECRECOVER    | 0x0020 | r := ecrecover(sig)                           |
| ECRECOVER    | 0x0021 | repeat r := ecrecover(sig)                    |
| SHA256       | 0x0022 | r := sha256(mem[0 .. limit+32])               |
| SHA256       | 0x0023 | repeat r := sha256(mem[0 .. 32])              |
| RIPEMD160    | 0x0024 | r := ripemd160(mem[0 .. limit+32])            |
| RIPEMD160    | 0x0025 | repeat r := ripemd160(mem[0 .. 32])           |
| MODEXP       | 0x0026 | r := modexp(base,exp,mod)                     |
| MODEXP       | 0x0027 | repeat r := modexp(base,exp,mod)              |
| ECADD        | 0x0028 | r := ecadd(P,Q)                               |
| ECADD        | 0x0029 | repeat r := ecadd(P,Q)                        |
| ECMUL        | 0x002A | r := ecmul(P,k)                               |
| ECMUL        | 0x002B | repeat r := ecmul(P,k)                        |
| ECPAIRING    | 0x002C | r := pairing(inputs)                          |
| ECPAIRING    | 0x002D | repeat r := pairing(inputs)                   |
| BLAKE2F      | 0x002E | r := blake2f(state)                           |
| BLAKE2F      | 0x002F | repeat r := blake2f(state)                    |
| POINTEVAL    | 0x0030 | r := point_eval(data)                         |
| POINTEVAL    | 0x0031 | repeat r := point_eval(data)                  |
| RIP-7212     | 0x0032 | r := rip7212_validate(sig,pk,msg)             |
| RIP-7212     | 0x0033 | repeat r := rip7212_validate(sig,pk,msg)      |
| BLAKE2F      | 0x0100 | blake2f(state) # limit defines rounds         |


* Deployment

Let's assume you want to run this somewhere.


#+begin_src bash
eth_address="0xfcC4D3152456d46a70a744f23D5311136AcB2DB4"
private_key="0x678ac44da86f317b7e484d6b206f96811a032394e68aa48138605d05849f9d3a"
rpc_url="https://sepolia.drpc.org"

# Compile it
docker run --volume "$PWD:/sources/" ethereum/solc:stable --strict-assembly --bin /sources/evm-stress.yul | tail -n 1  > evm-stress.yul.bin

# Wrap for deployment
polycli wrap-contract < evm-stress.yul.bin > evm-stress.yul.deploy.bin

# Deploy it
cast send --rpc-url "$rpc_url" --private-key "$private_key" 0x4e59b44847b379578588920ca78fbf26c0b4956c $(cast hz)$(sed 's/0x//' evm-stress.yul.deploy.bin)

# Get the address - it should be 0x863134579e4812F9d78081e9f519fAE9D01F2a10
cast create2 --salt $(cast hz) --init-code $(cat evm-stress.yul.deploy.bin)
#+end_src

This is the content of ~evm-stress.yul.deploy.bin~

#+begin_example
0x6300001132630000001560003963000011326000f35f35602035906040355f9160648410611127575b5f821461111e575b91825f1461111157826001146110f357826002146110e457826003146110c857826004146110bd57826005146110a25782600614611097578260071461107c578260081461107057826009146110525782600a146110465782600b146110265782600c1461101a5782600d14610ffa5782600e14610fef5782600f14610fc95782601014610fbe5782601114610f9c5782601214610f925782601314610f735782601414610f685782601514610f495782601614610f3f5782601714610f1c5782601814610f0e5782601914610eea5782601a14610edb5782601b14610ebd5782601c14610eae5782601d14610e6a5782601e14610e595782601f14610e16575081602014610d945781602114610d035781602214610ceb5781602314610ccb5781602414610cb3575080602514610c945780602614610bdb5780602714610b155780602814610aef5780602914610abc5780602a14610a9b5780602b14610a6d5780602c146108c55780602d146107085780602e146106775780602f146105f057806030146105015780603114610405578060321461033e578060331461026a57610100146101d257644641494c215f5260205ffd5b60e01b7c0148c9bdf267e6096a3ba7ca8485ae67bb2bf894fe72f36e3cf1361d5f175f527f3af54fa5d182e6ad7f520e511f6c3e2b8c68059b6bbd41fbabd9831f79217e136020526619cde05b61626360c81b6040525f6060525f6080525f60a0527b0300000000000000000000000000000001000000000000000000000060c05260405f60d5818060095af1505b60205fa060205ff35b507fb7b8486d949d2beef140ca44d4c8c0524dd53a250fadefa477b2db15b7d387765f527fbeb9e3aacfdc1408bfe5f876d9ab6f7c50e06a2d5f68aa500b9a2ff8965875976020527fba72bb78539ef6de9188a0ce5e6d694e2b0cb5aeda35d7ccbb335f6cb5e97d886040527f32f6471f0e06a4830d24eaecfac34e12ad223211a89c42aaf11f44ce3364233a6060527f4cfeddbcb7aa6aad4226715338725398546cb20ba2e8b133b2abae61cfc624d06080525b805a1161032c5750610261565b60205f60a081806101005af15061031f565b50507fb7b8486d949d2beef140ca44d4c8c0524dd53a250fadefa477b2db15b7d387765f527fbeb9e3aacfdc1408bfe5f876d9ab6f7c50e06a2d5f68aa500b9a2ff8965875976020527fba72bb78539ef6de9188a0ce5e6d694e2b0cb5aeda35d7ccbb335f6cb5e97d886040527f32f6471f0e06a4830d24eaecfac34e12ad223211a89c42aaf11f44ce3364233a6060527f4cfeddbcb7aa6aad4226715338725398546cb20ba2e8b133b2abae61cfc624d060805260205f60a081806101005af150610261565b507f01e798154708fe7789429634053cbf9f99b619f9f084048927333fce637f549b5f527f564c0a11a0f704f4fc3e8acfe0f8245f0ad1347b378fbf96e206da11a5d363066020527f24d25032e67a7e6a4910df5834b8fe70e6bcfeeac0352434196bdf4b2485d5a16040527f8f59a8d2a1a625a17f3fea0fe5eb8c896db3764f3185481bc22f91b4aaffcca26060527f5f26936857bc3a7c2539ea8ec3a952b7873033e038326e87ed3e1276fd1402536080527ffa08e9fc25fb2d9a98527fc22a2c9612fbeafdad446cbc7bcdbdcd780af2c16a60a0525b805a116104f0575060e0515f52610261565b604060c0805f80600a5af1506104de565b50507f01e798154708fe7789429634053cbf9f99b619f9f084048927333fce637f549b5f527f564c0a11a0f704f4fc3e8acfe0f8245f0ad1347b378fbf96e206da11a5d363066020527f24d25032e67a7e6a4910df5834b8fe70e6bcfeeac0352434196bdf4b2485d5a16040527f8f59a8d2a1a625a17f3fea0fe5eb8c896db3764f3185481bc22f91b4aaffcca26060527f5f26936857bc3a7c2539ea8ec3a952b7873033e038326e87ed3e1276fd1402536080527ffa08e9fc25fb2d9a98527fc22a2c9612fbeafdad446cbc7bcdbdcd780af2c16a60a05260405f60c08180600a5af1506020515f52610261565b507c0148c9bdf267e6096a3ba7ca8485ae67bb2bf894fe72f36e3cf1361d5f5f527f3af54fa5d182e6ad7f520e511f6c3e2b8c68059b6bbd41fbabd9831f79217e136020526619cde05b61626360c81b6040525f6060525f6080525f60a052600360d81b60c0525b805a116106655750610261565b6040600460d55f8060095af150610658565b50507c0148c9bdf267e6096a3ba7ca8485ae67bb2bf894fe72f36e3cf1361d5f5f527f3af54fa5d182e6ad7f520e511f6c3e2b8c68059b6bbd41fbabd9831f79217e136020526619cde05b61626360c81b6040525f6060525f6080525f60a0527b0300000000000000000000000000000001000000000000000000000060c05260405f60d5818060095af150610261565b507f2cf44499d5d27bb186308b7af7af02ac5bc9eeb6a3d147c186b21fb1b76e18da5f527f2c0f001f52110ccfe69108924926e45f0b0c868df0e7bde1fe16d3242dc715f66020527f1fb19bb476f6b9e44e2a32234da8212f61cd63919354bc06aef31e3cfaff3ebc6040527f22606845ff186793914e03e21df544c34ffe2f2f3504de8a79d9159eca2d98d96060527f2bd368e28381e8eccb5fa81fc26cf3f048eea9abfdd85d7ed3ab3698d63e4f906080527f2fe02e47887507adf0ff1743cbac6ba291e66f59be6bd763950bb16041a0a85e60a052600160c0527f30644e72e131a029b85045b68181585d97816a916871ca8d3c208c16d87cfd4560e0527f1971ff0471b09fa93caaf13cbf443c1aede09cc4328f5a62aad45f40ec133eb4610100527f091058a3141822985733cbdddfed0fd8d6c104e9e9eff40bf5abfef9ab163bc7610120527f2a23af9a5ce2ba2796c1f4e453a370eb0af8c212d9dc9acd8fc02c2e907baea2610140527f23a8eb0b0996252cb548a4487da97b02422ebc0e834613f954de6c7e0afdc1fc610160525b805a116108b157506101a0515f52610261565b60206101a06101805f8060085af15061089e565b50507f2cf44499d5d27bb186308b7af7af02ac5bc9eeb6a3d147c186b21fb1b76e18da5f527f2c0f001f52110ccfe69108924926e45f0b0c868df0e7bde1fe16d3242dc715f66020527f1fb19bb476f6b9e44e2a32234da8212f61cd63919354bc06aef31e3cfaff3ebc6040527f22606845ff186793914e03e21df544c34ffe2f2f3504de8a79d9159eca2d98d96060527f2bd368e28381e8eccb5fa81fc26cf3f048eea9abfdd85d7ed3ab3698d63e4f906080527f2fe02e47887507adf0ff1743cbac6ba291e66f59be6bd763950bb16041a0a85e60a052600160c0527f30644e72e131a029b85045b68181585d97816a916871ca8d3c208c16d87cfd4560e0527f1971ff0471b09fa93caaf13cbf443c1aede09cc4328f5a62aad45f40ec133eb4610100527f091058a3141822985733cbdddfed0fd8d6c104e9e9eff40bf5abfef9ab163bc7610120527f2a23af9a5ce2ba2796c1f4e453a370eb0af8c212d9dc9acd8fc02c2e907baea2610140527f23a8eb0b0996252cb548a4487da97b02422ebc0e834613f954de6c7e0afdc1fc6101605260205f610180818060085af150610261565b5060015f52600260205260026040525b805a11610a8a5750610261565b60405f6080818060075af150610a7d565b505060015f526002602052600260405260405f6080818060075af150610261565b5060015f526002602052600160405260026060525b805a11610ade5750610261565b60405f6080818060065af150610ad1565b505060015f5260026020526001604052600260605260405f6080818060065af150610261565b5060405f526001602052604080527fe09ad9675465c53a109fac66a445c91b292d2bb2c5268addb30cd82f80fcb0036060527f3ff97c80a5fc6f39193ae969c6ede6710a6b7ac27078a06d90ef1c72e5c85fb56080527f02fc9e1f6beb81516545975218075ec2af118cd8798df6e08a147c60fd6095ac60a0527f2bb02c2908cf4dd7c81f11c289e4bce98f3553768f392a80ce22bf5c4f4a248c60c052606b60f81b60e0525b805a11610bc95750610261565b60405f610100818060055af150610bbc565b505060405f526001602052604080527fe09ad9675465c53a109fac66a445c91b292d2bb2c5268addb30cd82f80fcb0036060527f3ff97c80a5fc6f39193ae969c6ede6710a6b7ac27078a06d90ef1c72e5c85fb56080527f02fc9e1f6beb81516545975218075ec2af118cd8798df6e08a147c60fd6095ac60a0527f2bb02c2908cf4dd7c81f11c289e4bce98f3553768f392a80ce22bf5c4f4a248c60c052606b60f81b60e05260405f610100818060055af150610261565b505b805a11610ca35750610261565b60205f81818060035af150610c96565b5f9150826020939184925201818060035af150610261565b50505b805a11610cdb5750610261565b60205f81818060025af150610cce565b5f9150826020939184925201818060025af150610261565b50507f456e9aea5e197a1f1af7a3e85a3212fa4049a3ba34c2289b4c860fc0b0c64ef35f52601c6020527f9242685bf161793cc25603c231bc2f568eb630ea16aa137d2664ac80388256086040527f4f8ae3bd7535248d0bd448298cc2e2071e56992d0774dc340c368ae950852ada6060525b805a11610d835750610261565b60205f6080818060015af150610d76565b50505f6080818060016020957f456e9aea5e197a1f1af7a3e85a3212fa4049a3ba34c2289b4c860fc0b0c64ef38352601c87527f9242685bf161793cc25603c231bc2f568eb630ea16aa137d2664ac80388256086040527f4f8ae3bd7535248d0bd448298cc2e2071e56992d0774dc340c368ae950852ada606052f150610261565b929150507f6300000003630000001560003963000000036000f35f5ff300000000000000005f525b805a11610e4d57505f52610261565b9060185f80f590610e3e565b50825f939250528180f55f52610261565b929150507f6300000003630000001560003963000000036000f35f5ff300000000000000005f525b805a11610ea157505f52610261565b905060185f80f090610e92565b50905081525f80f05f52610261565b5050505b805a11610ece5750610261565b5f808080602081a4610ec1565b5050505f8080809381a4610261565b92809250525b805a11610eff57505f52610261565b9080602080925f5e0190610ef0565b509050815260205f5e610261565b5050505f905b805a11610f3157505f52610261565b908080600192550190610f22565b5091905055610261565b5050505f905b805a11610f5e57505f52610261565b9060010190610f4f565b505050545f52610261565b5090505f5b825a11610f8757505050610261565b818152602001610f78565b5091905052610261565b509190505f9181525b805a11610fb457505f52610261565b9060200190610fa5565b505050515f52610261565b9291505043905b805a11610fe05750505f52610261565b90915060018240920390610fd0565b505050405f52610261565b9291505b815a1161100e5750505f52610261565b809192503f9190610ffe565b509150503f5f52610261565b9291505b815a1161103a5750505f52610261565b809192503b919061102a565b509150503b5f52610261565b509190505b805a11611065575050610261565b60205f80843c611057565b505f915081903c610261565b5050505b805a1161108d5750610261565b60205f8039611080565b5050505f8039610261565b5050505b805a116110b35750610261565b60205f80376110a6565b5050505f8037610261565b5050505b805a116110d95750610261565b60205f205f526110cc565b50905081526020205f52610261565b929150505b805a1161110757505f52610261565b90600101906110f8565b5050506001015f52610261565b9050309061001b565b92506127109261001356
#+end_example

* Running

Let's assume the contract is deployed at
~0x863134579e4812F9d78081e9f519fAE9D01F2a10~ we can make some example
calls:

#+begin_src bash
eth_address="0xfcC4D3152456d46a70a744f23D5311136AcB2DB4"
private_key="0x678ac44da86f317b7e484d6b206f96811a032394e68aa48138605d05849f9d3a"
rpc_url="https://sepolia.drpc.org"

# Run ADD in a loop with 5M gas. Stop looping once there is 100000 gas left
# 0x1cd5a5f1ab0d7ffaa7d1b2bca6147766e2bba4a989d65f730bb25d043e0be1ac
cast send --rpc-url "$rpc_url" --private-key "$private_key" \
    --gas-limit 5000000 \
    0x863134579e4812F9d78081e9f519fAE9D01F2a10 $(cast abi-encode 'f(uint256,uint256,uint256)' 0x0001 100000 0x0000000000000000000000000000000000000000)

# Run EXTCODEHASH in a loop with 5M gas. Stop looping once there is 100000 gas left. Use 0x0037e0d430a185E0506C910e384333d7F9Ed42A0 as the extaddress since it's large
# 0xf1eeaa162b537850056469223289a39d7c5cbf7ce20a10cf149bf0286554b961
cast send --rpc-url "$rpc_url" --private-key "$private_key" \
    --gas-limit 5000000 \
    0x863134579e4812F9d78081e9f519fAE9D01F2a10 $(cast abi-encode 'f(uint256,uint256,uint256)' 0x000D 100000 0x0037e0d430a185E0506C910e384333d7F9Ed42A0)

# Run BLAKE2F with a gas limit of 5M and with 4M rounds
# 0x5c0e4955c0804a03ea50b8fc0d8028bc22841b618796f2aabe6e2c878cc6e4ee
cast send --rpc-url "$rpc_url" --private-key "$private_key" \
    --gas-limit 5000000 \
    0x863134579e4812F9d78081e9f519fAE9D01F2a10 $(cast abi-encode 'f(uint256,uint256,uint256)' 0x0100 4000000 0x0000000000000000000000000000000000000000)
#+end_src
